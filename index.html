<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生管理系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .table-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .pulse-animation {
                animation: pulse 1.5s infinite;
            }
            .bounce-animation {
                animation: bounce 0.5s ease;
            }
            .scale-animation {
                transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .scale-animation:hover {
                transform: scale(1.03);
            }
            .rotate-animation {
                transition: transform 0.5s ease;
            }
            .rotate-animation:hover {
                transform: rotate(3deg) scale(1.05);
            }
            .pagination-btn {
                @apply px-3 py-1 border border-gray-300 rounded hover:bg-primary hover:text-white hover:border-primary transition-all-300;
            }
            .pagination-btn.active {
                @apply bg-primary text-white border-primary;
            }
            .pagination-btn:disabled {
                @apply opacity-50 cursor-not-allowed hover:bg-transparent hover:text-gray-500 hover:border-gray-300;
            }
            .table-header {
                @apply sticky top-0 z-10 bg-gray-50;
            }
            .table-row-highlight {
                @apply bg-primary/10;
            }
            .score-btn {
                @apply w-6 h-6 flex items-center justify-center rounded-full text-sm font-bold transition-all-300;
            }
            .score-btn.plus {
                @apply bg-green-100 text-green-600 hover:bg-green-200;
            }
            .score-btn.minus {
                @apply bg-red-100 text-red-600 hover:bg-red-200;
            }
            .score-container {
                @apply flex items-center justify-center space-x-1;
            }
            .score-value {
                @apply min-w-[40px] text-center;
            }
            .login-card {
                @apply bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4 transform transition-all duration-500 hover:shadow-2xl;
            }
            .form-input {
                @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all;
            }
            .btn-primary {
                @apply bg-primary text-white px-6 py-3 rounded-lg shadow-md font-medium hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 px-6 py-3 rounded-lg shadow-md font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition-all;
            }
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        /* 通知动画 */
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        /* 表格容器样式，用于固定表头 */
        .table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        /* 登录页面背景 */
        .login-bg {
            background: linear-gradient(135deg, #3B82F6 0%, #10B981 100%);
        }
        
        /* 调整输入框内边距，避免文字与图标重叠 */
        .icon-input {
            padding-left: 3rem !important;
        }
    </style>
</head>

<body class="font-sans text-dark min-h-screen flex flex-col">
    <!-- 全局通知组件 - 悬浮在页面顶部 -->
    <div id="status-message"
        class="fixed top-0 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-b-lg shadow-lg flex items-center hidden"
        style="animation: slideDown 0.3s ease forwards;">
        <i id="message-icon" class="mr-3 text-xl"></i>
        <span id="message-text"></span>
    </div>

    <!-- 主系统页面 -->
    <div id="main-system" class="flex flex-col min-h-screen bg-gray-50">
        <!-- 顶部导航 -->
        <header class="bg-white shadow-md sticky top-0 z-40 transition-all duration-300">
            <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-primary text-white p-2 rounded-lg rotate-animation">
                        <i class="fa fa-graduation-cap text-xl"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold text-primary">学生管理系统</h1>
                </div>

                <div class="flex items-center space-x-4 mt-2 md:mt-0">
                    <!-- 账户设置按钮 -->
                    <button id="account-settings-btn"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation">
                        <i class="fa fa-cog mr-2"></i>账户设置
                    </button>

                    <button id="roll-call-btn"
                        class="bg-accent text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation">
                        <i class="fa fa-random mr-2"></i>点名
                    </button>

                    <button id="history-btn"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation">
                        <i class="fa fa-history mr-2"></i>历史回退
                    </button>

                    <div class="flex space-x-2">
                        <label for="file-upload"
                            class="bg-primary text-white px-4 py-2 rounded-lg shadow flex items-center cursor-pointer scale-animation">
                            <i class="fa fa-upload mr-2"></i>导入
                        </label>
                        <input id="file-upload" type="file" accept=".xlsx,.xls" class="hidden">

                        <button id="export-btn"
                            class="bg-secondary text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation">
                            <i class="fa fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 搜索和筛选区 (固定在顶部) -->
        <div id="search-container" class="bg-white shadow-md sticky top-[61px] z-30 transition-all duration-300">
            <div class="container mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- 搜索框 -->
                    <div class="relative flex-grow">
                        <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="搜索学号、班级或姓名..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                    </div>

                    <!-- 班级筛选 -->
                    <div class="w-full md:w-auto">
                        <select id="class-filter"
                            class="w-full md:w-48 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none appearance-none bg-white transition-all">
                            <option value="">所有班级</option>
                            <!-- 班级选项将由JS动态生成 -->
                        </select>
                    </div>

                    <!-- 每页显示数量 -->
                    <div class="w-full md:w-auto">
                        <select id="page-size"
                            class="w-full md:w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none appearance-none bg-white transition-all">
                            <option value="10">10条/页</option>
                            <option value="20">20条/页</option>
                            <option value="50">50条/页</option>
                            <option value="100">100条/页</option>
                        </select>
                    </div>

                    <!-- 批量操作按钮 -->
                    <div class="flex gap-2">
                        <button id="add-btn"
                            class="bg-primary text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation">
                            <i class="fa fa-plus mr-2"></i>添加
                        </button>
                        <button id="delete-selected-btn"
                            class="bg-danger text-white px-4 py-2 rounded-lg shadow flex items-center scale-animation"
                            disabled>
                            <i class="fa fa-trash mr-2"></i>删除所选
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <main class="flex-grow container mx-auto px-4 pb-6 pt-6">
            <!-- 表格区域 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <!-- 表格容器，用于固定表头 -->
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="table-header">
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16 whitespace-nowrap">
                                    <input type="checkbox" id="select-all"
                                        class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                                </th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12 whitespace-nowrap">
                                    序号</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    班级</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    姓名</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    学号</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    缺勤</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    平时分</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                                    备注</th>
                                <th scope="col"
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16 whitespace-nowrap">
                                    操作</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- 表格内容将由JS动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 空状态显示 -->
                <div id="empty-state" class="flex flex-col items-center justify-center py-16 text-center">
                    <div class="w-24 h-24 bg-primary/10 rounded-full flex items-center justify-center mb-6">
                        <i class="fa fa-users text-4xl text-primary"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">暂无学生数据</h3>
                    <p class="text-gray-500 max-w-md mb-6">请导入Excel文件或点击添加按钮开始添加学生信息</p>
                    <button id="empty-add-btn"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <i class="fa fa-plus mr-2"></i>添加学生
                    </button>
                </div>
            </div>

            <!-- 分页控件 -->
            <div id="pagination-container"
                class="flex flex-col md:flex-row justify-between items-center mt-6 bg-white p-4 rounded-lg shadow-md hidden">
                <div class="text-sm text-gray-600 mb-4 md:mb-0">
                    显示 <span id="start-record">1</span>-<span id="end-record">10</span> 条，共 <span
                        id="total-records">0</span> 条记录
                </div>
                <div class="flex items-center space-x-1">
                    <button id="first-page" class="pagination-btn" disabled>
                        <i class="fa fa-angle-double-left"></i>
                    </button>
                    <button id="prev-page" class="pagination-btn" disabled>
                        <i class="fa fa-angle-left"></i>
                    </button>
                    <div id="page-numbers" class="flex items-center space-x-1">
                        <!-- 页码将由JS动态生成 -->
                    </div>
                    <button id="next-page" class="pagination-btn" disabled>
                        <i class="fa fa-angle-right"></i>
                    </button>
                    <button id="last-page" class="pagination-btn" disabled>
                        <i class="fa fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- 点名功能模态框 -->
        <div id="roll-call-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl transform transition-all">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-primary">随机点名</h2>
                    <div class="text-sm text-gray-500">
                        当前班级: <span id="current-roll-call-class">所有班级</span>
                    </div>
                    <button id="close-roll-call" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <div class="text-center py-10">
                    <div id="roll-call-display"
                        class="text-4xl font-bold text-gray-800 mb-6 min-h-[100px] flex items-center justify-center">
                        准备开始点名...
                    </div>

                    <div class="flex justify-center gap-4">
                        <button id="start-roll-call"
                            class="bg-accent text-white px-6 py-3 rounded-lg shadow-lg text-lg scale-animation">
                            <i class="fa fa-play mr-2"></i>开始
                        </button>
                        <button id="stop-roll-call"
                            class="bg-danger text-white px-6 py-3 rounded-lg shadow-lg text-lg scale-animation"
                            disabled>
                            <i class="fa fa-stop mr-2"></i>停止
                        </button>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="font-medium text-gray-700 mb-3">点名记录</h3>
                    <div id="roll-call-history" class="max-h-32 overflow-y-auto space-y-2 text-sm">
                        <!-- 点名记录将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加/编辑学生模态框 -->
        <div id="student-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-xl font-bold text-primary">添加学生</h2>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <form id="student-form">
                    <input type="hidden" id="student-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="class" class="block text-sm font-medium text-gray-700 mb-1">班级</label>
                            <input type="text" id="class" name="class" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>

                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                            <input type="text" id="name" name="name" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>

                        <div>
                            <label for="student-id-number"
                                class="block text-sm font-medium text-gray-700 mb-1">学号</label>
                            <input type="text" id="student-id-number" name="student-id-number" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>

                        <div>
                            <label for="absence" class="block text-sm font-medium text-gray-700 mb-1">缺勤</label>
                            <input type="number" id="absence" name="absence" min="0" value="0" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        </div>

                        <div>
                            <label for="daily-score" class="block text-sm font-medium text-gray-700 mb-1">平时分</label>
                            <input type="number" id="daily-score" name="daily-score" min="0" max="100" value="0"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <p class="text-xs text-gray-500 mt-1">平时分范围：0-100分，每次增减5分</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="notes" name="notes" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-btn"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            保存
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 账户设置模态框 -->
        <div id="account-modal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="account-modal-title" class="text-xl font-bold text-primary">账户设置</h2>
                    <button id="account-modal-close" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>

                <form id="account-form">
                    <div class="mb-4">
                        <label for="current-username" class="block text-sm font-medium text-gray-700 mb-1">当前用户名</label>
                        <input type="text" id="current-username" value="admin" readonly
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                    </div>

                    <div class="mb-4">
                        <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">新用户名</label>
                        <input type="text" id="new-username" placeholder="不修改请留空"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div class="mb-4">
                        <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
                        <input type="password" id="current-password"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div class="mb-4">
                        <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                        <input type="password" id="new-password" placeholder="不修改请留空"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <p class="text-xs text-gray-500 mt-1">密码长度至少6位</p>
                    </div>

                    <div class="mb-6">
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                        <input type="password" id="confirm-password" placeholder="不修改请留空"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-account-btn"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            保存设置
                        </button>
                    </div>
                </form>

                <div id="account-error" class="mt-4 text-center text-danger hidden">
                    <i class="fa fa-exclamation-circle mr-1"></i>
                    <span id="account-error-message">操作失败，请重试</span>
                </div>

                <div id="account-success" class="mt-4 text-center text-green-600 hidden">
                    <i class="fa fa-check-circle mr-1"></i>
                    <span>账户信息更新成功</span>
                </div>
            </div>
        </div>

        <!-- 数据同步状态 -->
        <div id="sync-status"
            class="fixed bottom-4 right-4 bg-dark text-white px-4 py-2 rounded-lg shadow-lg flex items-center text-sm z-30">
            <i id="sync-icon" class="fa fa-cloud mr-2"></i>
            <span id="sync-text">数据已同步</span>
        </div>

    </div>

    <script>
        // 全局变量
        let students = [];          // 学生数据数组
        let filteredStudents = [];  // 筛选后的学生数据
        let selectedIds = new Set();// 选中的学生ID集合
        let historyRecords = [];    // 历史记录数组
        let historyIndex = -1;      // 当前历史记录索引
        let rollCallInterval = null;// 点名计时器
        let isRolling = false;      // 是否正在点名

        // 分页相关变量
        let currentPage = 1;        // 当前页码
        let pageSize = 10;          // 每页显示数量
        let totalPages = 1;         // 总页数

        // DOM元素
        let studentTableBody, emptyState, classFilter, searchInput, selectAllCheckbox;
        let deleteSelectedBtn, addBtn, emptyAddBtn, fileUpload, exportBtn;
        let studentModal, modalTitle, closeModalBtn, cancelBtn, studentForm;
        let rollCallBtn, rollCallModal, closeRollCallBtn, startRollCallBtn;
        let stopRollCallBtn, rollCallDisplay, rollCallHistory, historyBtn;
        let statusMessage, messageIcon, messageText, saveIndicator;
        let searchContainer, currentRollCallClass, syncStatus, syncIcon, syncText;
        let accountSettingsBtn, accountModal, cancelAccountBtn, accountForm;
        let currentUsernameInput, newUsernameInput, currentPasswordInput;
        let newPasswordInput, confirmPasswordInput, accountError, accountSuccess;
        let accountErrorMessage;

        // 分页相关DOM元素
        let paginationContainer, firstPageBtn, prevPageBtn, nextPageBtn, lastPageBtn;
        let pageNumbersContainer, startRecordSpan, endRecordSpan, totalRecordsSpan;
        let pageSizeSelect;

        // 初始化应用
        function initApp() {
            // 直接显示主系统
            initDOMReferences();
            // 加载保存的数据
            loadData();
            // 加载历史记录
            loadHistory();
            // 初始化分页设置
            initPagination();
            // 添加事件监听器
            addEventListeners();
            // 检查数据同步状态
            checkSyncStatus();
        }

        // ==============================================
        // 账户系统相关功能
        // ==============================================

        // 默认账户信息
        function getDefaultAccount() {
            return { username: 'admin', password: '123456' };
        }

        // 初始化账户系统
        function initAccountSystem() {
            // 检查是否已有账户数据，没有则初始化默认账户
            const account = getAccount();
            if (!account) {
                saveAccount(getDefaultAccount());
            }
        }

        // 从localStorage获取账户数据
        function getAccount() {
            const accountJson = localStorage.getItem('systemAccount');
            return accountJson ? JSON.parse(accountJson) : null;
        }

        // 保存账户数据到localStorage
        function saveAccount(account) {
            localStorage.setItem('systemAccount', JSON.stringify(account));
        }

        // 更新账户信息
        function updateAccount(currentUsername, newUsername, currentPassword, newPassword) {
            const account = getAccount() || getDefaultAccount();

            // 验证当前密码
            if (account.password !== currentPassword) {
                return false; // 当前密码不正确
            }

            // 更新用户名（如果提供了新用户名）
            if (newUsername && newUsername.trim() !== '' && newUsername !== currentUsername) {
                account.username = newUsername;
            }

            // 更新密码（如果提供了新密码）
            if (newPassword && newPassword.trim() !== '') {
                account.password = newPassword;
            }

            // 保存更新后的账户信息
            saveAccount(account);
            return true;
        }

        // ==============================================
        // DOM元素初始化
        // ==============================================

        // 初始化主系统DOM元素引用
        function initDOMReferences() {
            // 学生管理相关元素
            studentTableBody = document.getElementById('student-table-body');
            emptyState = document.getElementById('empty-state');
            classFilter = document.getElementById('class-filter');
            searchInput = document.getElementById('search-input');
            selectAllCheckbox = document.getElementById('select-all');
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
            addBtn = document.getElementById('add-btn');
            emptyAddBtn = document.getElementById('empty-add-btn');
            fileUpload = document.getElementById('file-upload');
            exportBtn = document.getElementById('export-btn');
            studentModal = document.getElementById('student-modal');
            modalTitle = document.getElementById('modal-title');
            closeModalBtn = document.getElementById('close-modal');
            cancelBtn = document.getElementById('cancel-btn');
            studentForm = document.getElementById('student-form');
            rollCallBtn = document.getElementById('roll-call-btn');
            rollCallModal = document.getElementById('roll-call-modal');
            closeRollCallBtn = document.getElementById('close-roll-call');
            startRollCallBtn = document.getElementById('start-roll-call');
            stopRollCallBtn = document.getElementById('stop-roll-call');
            rollCallDisplay = document.getElementById('roll-call-display');
            rollCallHistory = document.getElementById('roll-call-history');
            historyBtn = document.getElementById('history-btn');
            statusMessage = document.getElementById('status-message');
            messageIcon = document.getElementById('message-icon');
            messageText = document.getElementById('message-text');
            saveIndicator = document.getElementById('save-indicator');
            searchContainer = document.getElementById('search-container');
            currentRollCallClass = document.getElementById('current-roll-call-class');
            syncStatus = document.getElementById('sync-status');
            syncIcon = document.getElementById('sync-icon');
            syncText = document.getElementById('sync-text');

            // 账户设置相关元素
            accountSettingsBtn = document.getElementById('account-settings-btn');
            accountModal = document.getElementById('account-modal');
            const accountModalClose = document.getElementById('account-modal-close');
            cancelAccountBtn = document.getElementById('cancel-account-btn');
            accountForm = document.getElementById('account-form');
            currentUsernameInput = document.getElementById('current-username');
            newUsernameInput = document.getElementById('new-username');
            currentPasswordInput = document.getElementById('current-password');
            newPasswordInput = document.getElementById('new-password');
            confirmPasswordInput = document.getElementById('confirm-password');
            accountError = document.getElementById('account-error');
            accountSuccess = document.getElementById('account-success');
            accountErrorMessage = document.getElementById('account-error-message');

            // 为账户模态框关闭按钮添加事件监听
            accountModalClose.addEventListener('click', closeAccountModal);

            // 分页相关DOM元素
            paginationContainer = document.getElementById('pagination-container');
            firstPageBtn = document.getElementById('first-page');
            prevPageBtn = document.getElementById('prev-page');
            nextPageBtn = document.getElementById('next-page');
            lastPageBtn = document.getElementById('last-page');
            pageNumbersContainer = document.getElementById('page-numbers');
            startRecordSpan = document.getElementById('start-record');
            endRecordSpan = document.getElementById('end-record');
            totalRecordsSpan = document.getElementById('total-records');
            pageSizeSelect = document.getElementById('page-size');

            // 初始化账户系统
            initAccountSystem();
            // 设置当前用户名
            const account = getAccount() || getDefaultAccount();
            currentUsernameInput.value = account.username;
        }

        // ==============================================
        // 事件监听器
        // ==============================================

        // 添加主系统事件监听器
        function addEventListeners() {
            // 筛选和搜索事件
            classFilter.addEventListener('change', filterAndPaginateStudents);
            searchInput.addEventListener('input', filterAndPaginateStudents);

            // 全选复选框事件
            selectAllCheckbox.addEventListener('change', handleSelectAll);

            // 批量删除按钮事件
            deleteSelectedBtn.addEventListener('click', deleteSelectedStudents);

            // 添加学生按钮事件
            addBtn.addEventListener('click', () => openStudentModal());
            emptyAddBtn.addEventListener('click', () => openStudentModal());

            // 模态框事件
            closeModalBtn.addEventListener('click', closeStudentModal);
            cancelBtn.addEventListener('click', closeStudentModal);
            studentForm.addEventListener('submit', handleFormSubmit);

            // 文件导入导出事件
            fileUpload.addEventListener('change', importExcel);
            exportBtn.addEventListener('click', exportExcel);

            // 点名功能事件
            rollCallBtn.addEventListener('click', openRollCallModal);
            closeRollCallBtn.addEventListener('click', closeRollCallModal);
            startRollCallBtn.addEventListener('click', startRollCall);
            stopRollCallBtn.addEventListener('click', stopRollCall);

            // 历史回退事件
            historyBtn.addEventListener('click', revertToPreviousState);

            // 分页事件
            firstPageBtn.addEventListener('click', goToFirstPage);
            prevPageBtn.addEventListener('click', goToPreviousPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            lastPageBtn.addEventListener('click', goToLastPage);
            pageSizeSelect.addEventListener('change', changePageSize);

            // 账户设置事件
            accountSettingsBtn.addEventListener('click', openAccountModal);
            cancelAccountBtn.addEventListener('click', closeAccountModal);
            accountForm.addEventListener('submit', handleAccountUpdate);

            // 为加减按钮添加事件委托
            studentTableBody.addEventListener('click', handleScoreButtonClick);
        }

        // ==============================================
        // 账户设置相关功能
        // ==============================================

        // 打开账户设置模态框
        function openAccountModal() {
            // 重置表单和状态
            accountForm.reset();
            accountError.classList.add('hidden');
            accountSuccess.classList.add('hidden');

            // 获取当前账户信息
            const account = getAccount() || getDefaultAccount();
            currentUsernameInput.value = account.username;

            // 显示模态框
            accountModal.classList.remove('hidden');
        }

        // 关闭账户设置模态框
        function closeAccountModal() {
            accountModal.classList.add('hidden');
        }

        // 处理账户信息更新
        function handleAccountUpdate(e) {
            e.preventDefault();

            // 隐藏之前的消息
            accountError.classList.add('hidden');
            accountSuccess.classList.add('hidden');

            // 获取表单数据
            const currentUsername = currentUsernameInput.value.trim();
            const newUsername = newUsernameInput.value.trim();
            const currentPassword = currentPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();

            // 验证当前密码不为空
            if (!currentPassword) {
                showAccountError('请输入当前密码');
                return;
            }

            // 如果提供了新密码，验证密码一致性和长度
            if (newPassword) {
                if (newPassword.length < 6) {
                    showAccountError('新密码长度至少为6位');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showAccountError('新密码和确认密码不一致');
                    return;
                }
            }

            // 更新账户信息
            const result = updateAccount(currentUsername, newUsername, currentPassword, newPassword);

            if (result === true) {
                // 更新成功
                accountSuccess.classList.remove('hidden');

                // 更新当前用户名显示
                const account = getAccount();
                currentUsernameInput.value = account.username;

                // 3秒后自动关闭
                setTimeout(() => {
                    closeAccountModal();
                }, 3000);
            } else {
                showAccountError('当前密码不正确，无法更新账户信息');
            }
        }

        // 显示账户操作错误信息
        function showAccountError(message) {
            accountErrorMessage.textContent = message;
            accountError.classList.remove('hidden');
            // 添加抖动动画
            accountError.classList.add('bounce-animation');
            setTimeout(() => {
                accountError.classList.remove('bounce-animation');
            }, 500);
        }

        // ==============================================
        // 分数操作相关功能
        // ==============================================

        // 处理分数加减按钮点击事件
        function handleScoreButtonClick(e) {
            // 检查是否点击了加分按钮
            if (e.target.closest('.score-btn.plus')) {
                const btn = e.target.closest('.score-btn.plus');
                const studentId = btn.dataset.studentId;
                const type = btn.dataset.type; // 'absence' 或 'dailyScore'

                if (type === 'absence') {
                    increaseAbsence(studentId);
                } else if (type === 'dailyScore') {
                    increaseDailyScore(studentId, 5); // 平时分每次加5分
                }
            }
            // 检查是否点击了减分按钮
            else if (e.target.closest('.score-btn.minus')) {
                const btn = e.target.closest('.score-btn.minus');
                const studentId = btn.dataset.studentId;
                const type = btn.dataset.type; // 'absence' 或 'dailyScore'

                if (type === 'absence') {
                    decreaseAbsence(studentId);
                } else if (type === 'dailyScore') {
                    decreaseDailyScore(studentId, 5); // 平时分每次减5分
                }
            }
        }

        // 增加缺勤次数
        function increaseAbsence(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.absence = (student.absence || 0) + 1;
                saveData();
                renderCurrentPageStudents();
                showMessage('缺勤次数已更新', 'success');
            }
        }

        // 减少缺勤次数
        function decreaseAbsence(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student && (student.absence || 0) > 0) {
                student.absence = (student.absence || 0) - 1;
                saveData();
                renderCurrentPageStudents();
                showMessage('缺勤次数已更新', 'success');
            } else if (student && (student.absence || 0) === 0) {
                showMessage('缺勤次数不能小于0', 'error');
            }
        }

        // 增加平时分
        function increaseDailyScore(studentId, points) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                const newScore = (student.dailyScore || 0) + points;
                // 确保平时分不超过100分
                if (newScore <= 100) {
                    student.dailyScore = newScore;
                    saveData();
                    renderCurrentPageStudents();
                    showMessage(`平时分已增加${points}分`, 'success');
                } else {
                    showMessage('平时分不能超过100分', 'error');
                }
            }
        }

        // 减少平时分
        function decreaseDailyScore(studentId, points) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                const newScore = (student.dailyScore || 0) - points;
                // 确保平时分不低于0分
                if (newScore >= 0) {
                    student.dailyScore = newScore;
                    saveData();
                    renderCurrentPageStudents();
                    showMessage(`平时分已减少${points}分`, 'success');
                } else {
                    showMessage('平时分不能小于0分', 'error');
                }
            }
        }

        // ==============================================
        // 分页相关功能
        // ==============================================

        // 初始化分页
        function initPagination() {
            // 从localStorage加载分页设置
            const savedPageSize = localStorage.getItem('studentPageSize');
            if (savedPageSize) {
                pageSize = parseInt(savedPageSize);
                pageSizeSelect.value = pageSize;
            }

            // 筛选并分页显示学生
            filterAndPaginateStudents();
        }

        // 筛选学生并进行分页
        function filterAndPaginateStudents() {
            const classValue = classFilter.value;
            const searchValue = searchInput.value.toLowerCase().trim();

            // 筛选学生
            filteredStudents = students.filter(student => {
                // 班级筛选
                const classMatch = !classValue || student.class === classValue;

                // 搜索筛选
                const searchMatch = !searchValue ||
                    student.studentId.toLowerCase().includes(searchValue) ||
                    student.class.toLowerCase().includes(searchValue) ||
                    student.name.toLowerCase().includes(searchValue);

                return classMatch && searchMatch;
            });

            // 重置到第一页
            currentPage = 1;

            // 计算总页数
            calculateTotalPages();

            // 更新分页控件
            updatePaginationControls();

            // 渲染当前页学生列表
            renderCurrentPageStudents();

            // 更新班级筛选器
            updateClassFilter();
        }

        // 计算总页数
        function calculateTotalPages() {
            totalPages = Math.max(1, Math.ceil(filteredStudents.length / pageSize));
        }

        // 更新分页控件
        function updatePaginationControls() {
            // 显示或隐藏分页容器
            if (filteredStudents.length === 0) {
                paginationContainer.classList.add('hidden');
                return;
            }
            paginationContainer.classList.remove('hidden');

            // 更新记录信息
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, filteredStudents.length);
            startRecordSpan.textContent = startRecord;
            endRecordSpan.textContent = endRecord;
            totalRecordsSpan.textContent = filteredStudents.length;

            // 更新按钮状态
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;

            // 生成页码按钮
            generatePageNumbers();
        }

        // 生成页码按钮
        function generatePageNumbers() {
            pageNumbersContainer.innerHTML = '';

            // 显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            // 确保至少显示5个页码（除非总页数少于5）
            if (endPage - startPage < 4 && totalPages >= 5) {
                if (startPage === 1) {
                    endPage = 5;
                } else if (endPage === totalPages) {
                    startPage = totalPages - 4;
                }
            }

            // 添加省略号（如果需要）
            if (startPage > 1) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'px-2 text-gray-500';
                ellipsis.textContent = '...';
                pageNumbersContainer.appendChild(ellipsis);
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => goToPage(i));
                pageNumbersContainer.appendChild(pageBtn);
            }

            // 添加省略号（如果需要）
            if (endPage < totalPages) {
                const ellipsis = document.createElement('span');
                ellipsis.className = 'px-2 text-gray-500';
                ellipsis.textContent = '...';
                pageNumbersContainer.appendChild(ellipsis);
            }
        }

        // 跳转到指定页
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            updatePaginationControls();
            renderCurrentPageStudents();

            // 滚动到表格顶部
            document.querySelector('.table-container').scrollTop = 0;
        }

        // 跳转到第一页
        function goToFirstPage() {
            goToPage(1);
        }

        // 跳转到上一页
        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }

        // 跳转到下一页
        function goToNextPage() {
            goToPage(currentPage + 1);
        }

        // 跳转到最后一页
        function goToLastPage() {
            goToPage(totalPages);
        }

        // 改变每页显示数量
        function changePageSize() {
            pageSize = parseInt(pageSizeSelect.value);
            // 保存到localStorage
            localStorage.setItem('studentPageSize', pageSize);
            // 重新计算并分页
            filterAndPaginateStudents();
        }

        // ==============================================
        // 学生表格渲染
        // ==============================================

        // 渲染当前页的学生列表
        function renderCurrentPageStudents() {
            // 清空表格
            studentTableBody.innerHTML = '';
            selectedIds.clear();
            selectAllCheckbox.checked = false;

            // 显示空状态或表格数据
            if (filteredStudents.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // 计算当前页的学生数据
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredStudents.length);
            const currentPageStudents = filteredStudents.slice(startIndex, endIndex);

            // 渲染每个学生行
            currentPageStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-primary/10 transition-all-300';
                row.dataset.id = student.id;

                // 计算全局序号（不是分页内的序号）
                const globalIndex = startIndex + index;

                // 确保平时分有默认值
                const dailyScore = student.dailyScore !== undefined ? student.dailyScore : 0;
                const absence = student.absence !== undefined ? student.absence : 0;

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <input type="checkbox" class="student-select h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary" 
                            data-id="${student.id}">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">${globalIndex + 1}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">${student.class || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">${student.name || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">${student.studentId || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                        <div class="score-container">
                            <button class="score-btn minus" data-student-id="${student.id}" data-type="absence">
                                <i class="fa fa-minus"></i>
                            </button>
                            <span class="score-value">${absence}</span>
                            <button class="score-btn plus" data-student-id="${student.id}" data-type="absence">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                        <div class="score-container">
                            <button class="score-btn minus" data-student-id="${student.id}" data-type="dailyScore">
                                <i class="fa fa-minus"></i>
                            </button>
                            <span class="score-value">${dailyScore}</span>
                            <button class="score-btn plus" data-student-id="${student.id}" data-type="dailyScore">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-center">${student.notes || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-center">
                        <button class="edit-btn text-primary hover:text-primary/80 mr-3" data-id="${student.id}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-btn text-danger hover:text-danger/80" data-id="${student.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;

                studentTableBody.appendChild(row);
            });

            // 添加行内按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    editStudent(id);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    deleteStudent(id);
                });
            });

            document.querySelectorAll('.student-select').forEach(checkbox => {
                checkbox.addEventListener('change', handleStudentSelect);
            });

            // 更新删除按钮状态
            updateDeleteButtonState();
        }

        // ==============================================
        // 学生数据管理
        // ==============================================

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 更新班级筛选器
        function updateClassFilter() {
            // 获取所有唯一的班级
            const classes = [...new Set(students.map(student => student.class).filter(c => c))];

            // 保存当前选中的值
            const currentValue = classFilter.value;

            // 清空现有选项（保留"所有班级"）
            while (classFilter.options.length > 1) {
                classFilter.remove(1);
            }

            // 添加班级选项
            classes.forEach(className => {
                if (className) {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classFilter.appendChild(option);
                }
            });

            // 恢复选中的值
            if (currentValue && classes.includes(currentValue)) {
                classFilter.value = currentValue;
            }
        }

        // 处理全选
        function handleSelectAll(e) {
            const isChecked = e.target.checked;

            // 获取当前页的学生ID
            const currentPageStudentIds = Array.from(studentTableBody.querySelectorAll('tr'))
                .map(row => row.dataset.id);

            if (isChecked) {
                // 选中当前页所有学生
                currentPageStudentIds.forEach(id => {
                    selectedIds.add(id);
                });
            } else {
                // 取消选中当前页所有学生
                currentPageStudentIds.forEach(id => {
                    selectedIds.delete(id);
                });
            }

            // 更新复选框状态并添加/移除高亮
            document.querySelectorAll('tr').forEach(row => {
                const checkbox = row.querySelector('.student-select');
                if (checkbox) {
                    checkbox.checked = isChecked;
                    if (isChecked) {
                        row.classList.add('table-row-highlight');
                    } else {
                        row.classList.remove('table-row-highlight');
                    }
                }
            });

            // 更新删除按钮状态
            updateDeleteButtonState();
        }

        // 处理单个学生选择
        function handleStudentSelect(e) {
            const id = e.target.dataset.id;
            const row = e.target.closest('tr');

            if (e.target.checked) {
                selectedIds.add(id);
                row.classList.add('table-row-highlight');
            } else {
                selectedIds.delete(id);
                row.classList.remove('table-row-highlight');
            }

            // 更新全选框状态
            updateSelectAllState();

            // 更新删除按钮状态
            updateDeleteButtonState();
        }

        // 更新全选框状态
        function updateSelectAllState() {
            const currentPageStudentIds = Array.from(studentTableBody.querySelectorAll('tr'))
                .map(row => row.dataset.id);

            // 检查当前页所有学生是否都被选中
            const allSelected = currentPageStudentIds.every(id => selectedIds.has(id));
            selectAllCheckbox.checked = allSelected;
        }

        // 更新删除按钮状态
        function updateDeleteButtonState() {
            deleteSelectedBtn.disabled = selectedIds.size === 0;
        }

        // 打开学生模态框
        function openStudentModal(student = null) {
            // 重置表单
            studentForm.reset();
            document.getElementById('student-id').value = '';

            if (student) {
                // 编辑模式
                modalTitle.textContent = '编辑学生';
                document.getElementById('student-id').value = student.id;
                document.getElementById('class').value = student.class || '';
                document.getElementById('name').value = student.name || '';
                document.getElementById('student-id-number').value = student.studentId || '';
                document.getElementById('absence').value = student.absence !== undefined ? student.absence : 0;
                document.getElementById('daily-score').value = student.dailyScore !== undefined ? student.dailyScore : 0;
                document.getElementById('notes').value = student.notes || '';
            } else {
                // 添加模式
                modalTitle.textContent = '添加学生';
                document.getElementById('daily-score').value = 0; // 默认平时分0分
                document.getElementById('absence').value = 0; // 默认缺勤0次
            }

            // 显示模态框
            studentModal.classList.remove('hidden');
        }

        // 关闭学生模态框
        function closeStudentModal() {
            studentModal.classList.add('hidden');
        }

        // 处理表单提交
        function handleFormSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('student-id').value;
            const studentData = {
                class: document.getElementById('class').value,
                name: document.getElementById('name').value,
                studentId: document.getElementById('student-id-number').value,
                absence: parseInt(document.getElementById('absence').value) || 0,
                dailyScore: parseInt(document.getElementById('daily-score').value) || 0,
                notes: document.getElementById('notes').value
            };

            // 验证平时分范围
            if (studentData.dailyScore < 0 || studentData.dailyScore > 100) {
                showMessage('平时分必须在0-100分之间', 'error');
                return;
            }

            // 验证缺勤次数不能为负数
            if (studentData.absence < 0) {
                showMessage('缺勤次数不能为负数', 'error');
                return;
            }

            if (id) {
                // 更新现有学生
                updateStudent(id, studentData);
            } else {
                // 添加新学生
                addStudent(studentData);
            }

            // 关闭模态框
            closeStudentModal();
        }

        // 添加学生
        function addStudent(studentData) {
            const newStudent = {
                id: generateId(),
                ...studentData
            };

            students.push(newStudent);

            // 保存数据并更新界面
            saveData();
            filterAndPaginateStudents();
            showMessage('学生添加成功', 'success');
        }

        // 编辑学生
        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (student) {
                openStudentModal(student);
            }
        }

        // 更新学生
        function updateStudent(id, studentData) {
            const index = students.findIndex(s => s.id === id);
            if (index !== -1) {
                students[index] = {
                    ...students[index],
                    ...studentData
                };

                // 保存数据并更新界面
                saveData();
                filterAndPaginateStudents();
                showMessage('学生信息更新成功', 'success');
            }
        }

        // 删除学生
        function deleteStudent(id) {
            if (confirm('确定要删除这个学生吗？')) {
                students = students.filter(student => student.id !== id);
                selectedIds.delete(id);

                // 保存数据并更新界面
                saveData();
                filterAndPaginateStudents();
                showMessage('学生已删除', 'success');
            }
        }

        // 删除选中的学生
        function deleteSelectedStudents() {
            if (selectedIds.size === 0) return;

            if (confirm(`确定要删除选中的 ${selectedIds.size} 个学生吗？`)) {
                // 保存要删除的数量
                const deletedCount = selectedIds.size;

                students = students.filter(student => !selectedIds.has(student.id));
                selectedIds.clear();
                selectAllCheckbox.checked = false;

                // 保存数据并更新界面
                saveData();
                filterAndPaginateStudents();
                showMessage(`已删除 ${deletedCount} 个学生`, 'success');
            }
        }

        // ==============================================
        // 导入导出功能
        // ==============================================

        // 导入Excel文件
        function importExcel(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // 将工作表转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        showMessage('Excel文件中没有数据', 'error');
                        return;
                    }

                    // 处理导入的数据（支持旧的"测验"列和新的"平时分"列）
                    const importedStudents = jsonData.map(item => ({
                        id: generateId(),
                        class: item.班级 || '',
                        name: item.姓名 || '',
                        studentId: item.学号 || '',
                        absence: parseInt(item.缺勤) || 0,
                        // 优先使用"平时分"列，如果没有则使用"测验"列
                        dailyScore: item.平时分 !== undefined ? parseInt(item.平时分) || 0 :
                            (item.测验 !== undefined ? parseInt(item.测验) || 0 : 0),
                        notes: item.备注 || ''
                    }));

                    // 添加到现有数据中
                    students = [...students, ...importedStudents];

                    // 保存数据并更新界面
                    saveData();
                    filterAndPaginateStudents();
                    showMessage(`成功导入 ${importedStudents.length} 条学生数据`, 'success');

                    // 重置文件输入
                    fileUpload.value = '';
                } catch (error) {
                    showMessage('文件解析错误，请确保上传的是有效的Excel文件', 'error');
                    console.error('Excel导入错误:', error);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // 导出Excel文件
        function exportExcel() {
            if (students.length === 0) {
                showMessage('没有学生数据可导出', 'error');
                return;
            }

            // 准备导出数据（使用"平时分"列）
            const exportData = students.map(student => ({
                班级: student.class || '',
                姓名: student.name || '',
                学号: student.studentId || '',
                缺勤: student.absence !== undefined ? student.absence : 0,
                平时分: student.dailyScore !== undefined ? student.dailyScore : 0,
                备注: student.notes || ''
            }));

            // 创建工作簿和工作表
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '学生信息');

            // 导出文件
            XLSX.writeFile(workbook, '学生信息表.xlsx');
            showMessage('Excel文件已导出为"学生信息表.xlsx"', 'success');

            // 模拟数据同步
            syncData();
        }

        // ==============================================
        // 点名功能
        // ==============================================

        // 打开点名模态框
        function openRollCallModal() {
            if (filteredStudents.length === 0) {
                showMessage('没有符合条件的学生数据，无法进行点名', 'error');
                return;
            }

            // 更新当前点名班级显示
            const currentClass = classFilter.value || '所有班级';
            currentRollCallClass.textContent = currentClass;

            rollCallDisplay.textContent = '准备开始点名...';
            rollCallModal.classList.remove('hidden');
        }

        // 关闭点名模态框
        function closeRollCallModal() {
            stopRollCall();
            rollCallModal.classList.add('hidden');
        }

        // 开始点名 - 只从筛选后的学生中抽取
        function startRollCall() {
            if (isRolling || filteredStudents.length === 0) return;

            isRolling = true;
            startRollCallBtn.disabled = true;
            stopRollCallBtn.disabled = false;

            // 添加动画效果
            rollCallDisplay.classList.add('pulse-animation');

            // 随机切换显示学生（只从筛选后的学生中）
            rollCallInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * filteredStudents.length);
                const randomStudent = filteredStudents[randomIndex];
                rollCallDisplay.textContent = `${randomStudent.class || '未知班级'} - ${randomStudent.name || '未知姓名'} (${randomStudent.studentId || '无学号'})`;
            }, 100);
        }

        // 停止点名
        function stopRollCall() {
            if (!isRolling) return;

            clearInterval(rollCallInterval);
            isRolling = false;
            startRollCallBtn.disabled = false;
            stopRollCallBtn.disabled = true;

            // 移除动画效果
            rollCallDisplay.classList.remove('pulse-animation');

            // 记录点名结果
            const selectedStudentText = rollCallDisplay.textContent;
            if (selectedStudentText !== '准备开始点名...') {
                addRollCallRecord(selectedStudentText);
            }
        }

        // 添加点名记录
        function addRollCallRecord(studentInfo) {
            const recordElement = document.createElement('div');
            recordElement.className = 'p-2 bg-gray-50 rounded border border-gray-200';

            const time = new Date().toLocaleTimeString();
            recordElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${studentInfo}</span>
                    <span class="text-xs text-gray-500">${time}</span>
                </div>
            `;

            rollCallHistory.prepend(recordElement);
        }

        // ==============================================
        // 数据存储和同步
        // ==============================================

        // 保存数据到localStorage并模拟云同步
        function saveData() {
            // 保存当前状态到历史记录
            saveToHistory();

            // 保存到localStorage
            localStorage.setItem('students', JSON.stringify(students));

            // 显示保存指示器动画
            showSaveIndicator();

            // 模拟数据同步到云端
            syncData();
        }

        // 模拟数据同步
        function syncData() {
            // 显示同步中状态
            syncIcon.className = 'fa fa-cloud-upload mr-2';
            syncText.textContent = '正在同步数据...';

            // 模拟同步延迟
            setTimeout(() => {
                syncIcon.className = 'fa fa-cloud-check mr-2';
                syncText.textContent = '数据已同步';

                // 3秒后隐藏同步状态
                setTimeout(() => {
                    syncStatus.style.opacity = '0';
                    setTimeout(() => {
                        syncStatus.style.display = 'none';
                    }, 300);
                }, 3000);
            }, 1000);

            // 确保同步状态可见
            syncStatus.style.display = 'flex';
            syncStatus.style.opacity = '1';
        }

        // 检查同步状态
        function checkSyncStatus() {
            syncStatus.style.display = 'flex';
            syncStatus.style.opacity = '1';

            syncIcon.className = 'fa fa-cloud mr-2';
            syncText.textContent = '数据已同步';

            // 3秒后隐藏
            setTimeout(() => {
                syncStatus.style.opacity = '0';
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // 从localStorage加载数据
        function loadData() {
            const savedData = localStorage.getItem('students');
            if (savedData) {
                try {
                    students = JSON.parse(savedData);
                    // 处理旧数据中的"test"字段，转换为"dailyScore"
                    students = students.map(student => {
                        if (student.test !== undefined && student.dailyScore === undefined) {
                            // 如果有test字段但没有dailyScore字段，进行转换
                            return {
                                ...student,
                                dailyScore: parseInt(student.test) || 0,
                                test: undefined // 移除旧字段
                            };
                        }
                        return student;
                    });
                    filteredStudents = [...students];
                } catch (error) {
                    console.error('加载数据失败:', error);
                    students = [];
                    filteredStudents = [];
                }
            }
        }

        // ==============================================
        // 历史记录功能
        // ==============================================

        // 保存当前状态到历史记录
        function saveToHistory() {
            // 移除当前索引之后的历史记录
            if (historyIndex < historyRecords.length - 1) {
                historyRecords = historyRecords.slice(0, historyIndex + 1);
            }

            // 保存当前状态的深拷贝
            const currentState = JSON.parse(JSON.stringify(students));
            historyRecords.push(currentState);

            // 限制历史记录数量为50条
            if (historyRecords.length > 50) {
                historyRecords.shift();
            }

            // 更新当前历史索引
            historyIndex = historyRecords.length - 1;

            // 保存历史记录到localStorage
            localStorage.setItem('studentHistory', JSON.stringify(historyRecords));
        }

        // 加载历史记录
        function loadHistory() {
            const savedHistory = localStorage.getItem('studentHistory');
            if (savedHistory) {
                try {
                    historyRecords = JSON.parse(savedHistory);
                    historyIndex = historyRecords.length - 1;
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    historyRecords = [];
                    historyIndex = -1;
                }
            }
        }

        // 回退到上一个状态
        function revertToPreviousState() {
            if (historyIndex <= 0) {
                showMessage('已经是最早的记录了', 'info');
                return;
            }

            historyIndex--;
            students = JSON.parse(JSON.stringify(historyRecords[historyIndex]));
            filteredStudents = [...students];

            // 更新界面
            saveData(); // 这会创建一个新的历史记录点
            filterAndPaginateStudents();
            showMessage('已回退到上一个状态', 'success');
        }

        // ==============================================
        // 辅助功能
        // ==============================================

        // 显示保存指示器
        function showSaveIndicator() {
            // 确保元素存在
            if (!saveIndicator) {
                // 重新获取元素引用
                const indicator = document.getElementById('save-indicator');
                if (indicator) {
                    saveIndicator = indicator;
                } else {
                    // 如果元素不存在，直接返回避免错误
                    return;
                }
            }

            // 操作classList
            saveIndicator.classList.add('bg-green-500');
            saveIndicator.classList.remove('bg-yellow-500');

            setTimeout(() => {
                if (saveIndicator) { // 再次检查
                    saveIndicator.classList.add('animate-pulse');
                    setTimeout(() => {
                        if (saveIndicator) { // 再次检查
                            saveIndicator.classList.remove('animate-pulse');
                        }
                    }, 1000);
                }
            }, 100);
        }

        // 显示消息 - 悬浮在页面顶部，不影响其他元素
        function showMessage(text, type = 'info') {
            // 清除任何现有的消息定时器
            if (window.messageTimeout) {
                clearTimeout(window.messageTimeout);
            }

            // 设置消息类型样式
            if (type === 'success') {
                statusMessage.className = 'fixed top-0 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-b-lg shadow-lg flex items-center bg-green-50 text-green-800 border border-green-200';
                messageIcon.className = 'mr-3 text-xl fa fa-check-circle';
            } else if (type === 'error') {
                statusMessage.className = 'fixed top-0 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-b-lg shadow-lg flex items-center bg-red-50 text-red-800 border border-red-200';
                messageIcon.className = 'mr-3 text-xl fa fa-exclamation-circle';
            } else {
                statusMessage.className = 'fixed top-0 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-b-lg shadow-lg flex items-center bg-blue-50 text-blue-800 border border-blue-200';
                messageIcon.className = 'mr-3 text-xl fa fa-info-circle';
            }

            // 设置消息内容
            messageText.textContent = text;

            // 显示消息并添加动画
            statusMessage.style.display = 'flex';
            statusMessage.style.animation = 'slideDown 0.3s ease forwards';

            // 3秒后自动隐藏
            window.messageTimeout = setTimeout(() => {
                statusMessage.style.animation = 'slideUp 0.3s ease forwards';
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // 页面关闭时保存数据
        window.addEventListener('beforeunload', () => {
            saveData();
        });

        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>